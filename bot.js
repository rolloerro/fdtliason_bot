// ‚úÖ –ò–º–ø–æ—Ä—Ç—ã
import { Telegraf, Markup } from "telegraf";
import * as dotenv from "dotenv";
import fs from "fs";
import path from "path";
import os from "os";

dotenv.config();

// ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_TOKEN);

// ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ PDF-—Ñ–∞–π–ª—É (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º Mac)
const pdfPath = "/Users/vladimirkopylov/Desktop/002.FDT Kazan.pdf";

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
if (!fs.existsSync(pdfPath)) {
  console.error("‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω:", pdfPath);
  process.exit(1);
}

// ‚úÖ –°–ø–∏—Å–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
const algorithms = [
  { title: "1.1. –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å", page: 11 },
  { title: "1.2. –§–î–¢ –±—É–¥—É—â–µ–≥–æ", page: 22 },
  { title: "1.3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –§–î–¢ –≤ –æ–Ω–∫–æ–ª–æ–≥–∏–∏", page: 31 },
  { title: "1.3.1. –§–î–¢ –ø—Ä–∏ –±–∞–∑–∞–ª—å–Ω–æ–∫–ª–µ—Ç–æ—á–Ω–æ–º —Ä–∞–∫–µ –∫–æ–∂–∏", page: 32 },
  { title: "1.3.2. –§–î–¢ –ø—Ä–∏ —Ä–∞–∫–µ –ø–∏—â–µ–≤–æ–¥–∞", page: 35 },
  { title: "1.3.3. –§–î–¢ –ø—Ä–∏ —Ä–∞–∫–µ –∂–µ–ª—É–¥–∫–∞", page: 39 },
  { title: "1.3.4. –§–î–¢ –Ω–µ–º—ã—à–µ—á–Ω–æ–∏–Ω–≤–∞–∑–∏–≤–Ω–æ–≥–æ —Ä–∞–∫–∞ –º–æ—á–µ–≤–æ–≥–æ –ø—É–∑—ã—Ä—è", page: 41 },
  { title: "1.3.5. –§–î–¢ –∫–æ–∂–Ω—ã—Ö –º–µ—Ç–∞—Å—Ç–∞–∑–æ–≤ –†–ú–ñ", page: 43 },
  { title: "1.3.6. –ò–Ω—Ç—Ä–∞–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –§–î–¢", page: 46 },
  { title: "1.3.7. –°–∏—Å—Ç–µ–º–Ω–∞—è –§–î–¢", page: 49 },
  { title: "1.4. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –§–î–¢", page: 55 },
  { title: "1.4.1. –§–æ—Ç–æ—Å–µ–Ω—Å–∏–±–∏–ª–∏–∑–∞—Ç–æ—Ä", page: 55 },
  { title: "1.4.2. –ò–∑–ª—É—á–µ–Ω–∏–µ", page: 63 },
  { title: "1.4.3. –ö–∏—Å–ª–æ—Ä–æ–¥ –∏ –ê–§–ö", page: 70 },
  { title: "1.5. –≠—Ñ—Ñ–µ–∫—Ç—ã –§–î–¢", page: 74 },
  { title: "1.6. –≠—Ç–∞–ø—ã –§–î–¢", page: 79 },
  { title: "1.7. –§–î–¢ –≤ –≥–∏–Ω–µ–∫–æ–ª–æ–≥–∏–∏", page: 94 },
  { title: "1.8. –†–æ–ª—å –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤", page: 100 },
  { title: "2.1. –ü—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –§–î–¢ —à–µ–π–∫–∏ –º–∞—Ç–∫–∏", page: 115 },
  { title: "2.1.1. –õ–µ—á–µ–Ω–∏–µ –ª—ë–≥–∫–æ–π –¥–∏—Å–ø–ª–∞–∑–∏–∏", page: 119 },
  { title: "2.1.2. –õ–µ—á–µ–Ω–∏–µ —Ç—è–∂—ë–ª–æ–π –¥–∏—Å–ø–ª–∞–∑–∏–∏", page: 130 },
  { title: "2.2. –õ–µ—á–µ–Ω–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –≤—É–ª—å–≤—ã", page: 138 },
  { title: "3. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±—É—á–µ–Ω–∏—è", page: 149 },
  { title: "4. –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è", page: 177 },
  { title: "5. –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –§–î–¢", page: 206 },
  { title: "6. –ê–≤—Ç–æ—Ä—Å–∫–∏–π –∫–æ–ª–ª–µ–∫—Ç–∏–≤", page: 209 },
];

// ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è
const PAGE_SIZE = 8;
function getPage(page) {
  const start = (page - 1) * PAGE_SIZE;
  const items = algorithms.slice(start, start + PAGE_SIZE);
  const buttons = items.map(a => [Markup.button.callback(a.title, `alg_${a.page}`)]);

  const controls = [];
  if (page > 1) controls.push(Markup.button.callback("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", `page_${page - 1}`));
  if (start + PAGE_SIZE < algorithms.length) controls.push(Markup.button.callback("‚û°Ô∏è –î–∞–ª–µ–µ", `page_${page + 1}`));

  return Markup.inlineKeyboard([...buttons, controls]);
}

// ‚úÖ –ö–æ–º–∞–Ω–¥–∞ /start
bot.start(ctx => {
  ctx.reply(
    "üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –ø—Ä–æ–µ–∫—Ç–∞ *Digital WM | FDT Liason*.\n" +
    "üìò –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: *¬´–§–æ—Ç–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è –í–ü–ß-–∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π –∂–µ–Ω—Å–∫–∏—Ö –ø–æ–ª–æ–≤—ã—Ö –æ—Ä–≥–∞–Ω–æ–≤¬ª*\n\n" +
    "–í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:",
    { ...getPage(1), parse_mode: "Markdown" }
  );
});

// ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
bot.action(/page_(\d+)/, ctx => {
  const page = parseInt(ctx.match[1]);
  ctx.editMessageReplyMarkup(getPage(page).reply_markup);
});

// ‚úÖ –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–¥–µ–ª–∞ (—Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF)
bot.action(/alg_(\d+)/, async ctx => {
  const page = parseInt(ctx.match[1]);
  await ctx.answerCbQuery();

  try {
    await ctx.replyWithDocument(
      { source: pdfPath },
      { caption: `üìÑ –†–∞–∑–¥–µ–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ${page}. –û—Ç–∫—Ä–æ–π PDF –∏ –ø–µ—Ä–µ–π–¥–∏ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.` }
    );
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ PDF:", error);
    await ctx.reply("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª. –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∏–ª–∏ –∏–º—è PDF.");
  }
});

// ‚úÖ –ö–æ–º–∞–Ω–¥–∞ /help
bot.command("help", ctx => {
  ctx.reply("‚ÑπÔ∏è –í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ –∏–ª–∏ –ª–∏—Å—Ç–∞–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚û°Ô∏è‚¨ÖÔ∏è");
});

// ‚úÖ –ó–∞–ø—É—Å–∫
bot.launch();
console.log("‚úÖ FDT Liason Bot –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!");
